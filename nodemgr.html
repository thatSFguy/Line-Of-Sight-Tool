<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Node Manager</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {font-family: Arial, sans-serif; margin:20px;}
        h1 {margin-bottom:5px;}
        .note {color:#b00; font-size:0.9em; margin-bottom:15px;}
        .form-group {margin:10px 0;}
        label {display:inline-block; width:130px;}
        input, select {width:200px;}
        button {margin:5px 0;}
        #map {height:400px; margin-top:20px;}
        table {border-collapse:collapse; width:100%; margin-top:15px;}
        th, td {border:1px solid #ccc; padding:6px; text-align:left;}
        th {background:#f0f0f0;}
        .icon {cursor:pointer; margin:0 4px; font-size:1.2em;}
        .icon:hover {color:#c00;}
    </style>
</head>
<body>
    <h1>Node Manager</h1>
    <p class="note">
        <strong>Important:</strong> All data is stored ONLY in your browser (localStorage). 
        Download your CSV before clearing your cache or using a different browser!
    </p>

    <!-- ==== NODE ENTRY ==== -->
    <div class="form-group">
        <label for="nodeName">Node Name:</label>
        <input type="text" id="nodeName" placeholder="e.g. BASE">
    </div>
    <div class="form-group">
        <label for="lat">Latitude:</label>
        <input type="number" step="any" id="lat" placeholder="e.g. 43.183">
    </div>
    <div class="form-group">
        <label for="lon">Longitude:</label>
        <input type="number" step="any" id="lon" placeholder="e.g. -85.5">
    </div>
    <div class="form-group">
        <label for="height">Height (m):</label>
        <input type="number" id="height" placeholder="optional">
    </div>
    <div class="form-group">
        <label for="notes">Notes:</label>
        <input type="text" id="notes" placeholder="optional">
    </div>
    <div class="form-group">
        <label for="primary">Primary Node:</label>
        <input type="checkbox" id="primary">
    </div>
    <button id="addNode">Add / Update Node</button>

    <!-- ==== GROUP MANAGEMENT ==== -->
    <hr>
    <h2>Groups</h2>
    <div class="form-group">
        <label for="groupName">Group Name:</label>
        <input type="text" id="groupName" placeholder="e.g. BASE">
    </div>
    <div class="form-group">
        <label>Include Nodes:</label><br>
        <div id="nodeCheckboxes"></div>
    </div>
    <button id="createGroup">Create Group</button>

    <!-- ==== GROUP LIST ==== -->
    <h3>Existing Groups</h3>
    <table id="groupTable">
        <thead><tr><th>Group</th><th>Nodes</th><th>Actions</th></tr></thead>
        <tbody></tbody>
    </table>

    <!-- ==== CLEAR ALL ==== -->
    <hr>
    <button id "clearAll" style="background:#c00;color:#fff;">Clear All Data</button>

    <div id="map"></div>

    <script>
        // ---------- Leaflet map ----------
        const map = L.map('map').setView([40, -100], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const primaryIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
            iconSize: [25,41], iconAnchor: [12,41]
        });
        const secondaryIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            iconSize: [25,41], iconAnchor: [12,41]
        });

        // ---------- LocalStorage helpers ----------
        function getNodes() { return JSON.parse(localStorage.getItem('nodes') || '[]'); }
        function saveNodes(arr) { localStorage.setItem('nodes', JSON.stringify(arr)); }
        function getGroups() { return JSON.parse(localStorage.getItem('groups') || '[]'); }
        function saveGroups(arr) { localStorage.setItem('groups', JSON.stringify(arr)); }

        // ---------- Render nodes on map ----------
        function renderMap() {
            map.eachLayer(l => { if (l instanceof L.Marker) map.removeLayer(l); });
            const nodes = getNodes();
            nodes.forEach(n => {
                const marker = L.marker([n.latitude, n.longitude], {
                    icon: n.primary ? primaryIcon : secondaryIcon
                }).addTo(map)
                  .bindPopup(`${n.name}<br>${n.notes||''}`);
            });
            if (nodes.length) {
                const group = new L.featureGroup(nodes.map(n=>L.marker([n.latitude,n.longitude])));
                map.fitBounds(group.getBounds().pad(0.2));
            }
        }

        // ---------- Node CRUD ----------
        document.getElementById('addNode').addEventListener('click', () => {
            const name = document.getElementById('nodeName').value.trim();
            const lat = parseFloat(document.getElementById('lat').value);
            const lon = parseFloat(document.getElementById('lon').value);
            const height = document.getElementById('height').value.trim() ? parseFloat(document.getElementById('height').value) : null;
            const notes = document.getElementById('notes').value.trim();
            const primary = document.getElementById('primary').checked;

            if (!name || isNaN(lat) || isNaN(lon)) {
                alert('Name, Latitude and Longitude are required.');
                return;
            }

            const nodes = getNodes();
            const existingIdx = nodes.findIndex(n => n.name === name);
            const nodeObj = {name, latitude:lat, longitude:lon, height, notes, primary};

            if (existingIdx > -1) {
                nodes[existingIdx] = nodeObj;               // update
            } else {
                nodes.push(nodeObj);                        // add
            }
            saveNodes(nodes);
            renderCheckboxes();
            renderMap();
            clearNodeForm();
        });

        function clearNodeForm() {
            document.getElementById('nodeName').value = '';
            document.getElementById('lat').value = '';
            document.getElementById('lon').value = '';
            document.getElementById('height').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('primary').checked = false;
        }

        // ---------- Group UI ----------
        let editingGroup = null;   // holds group name when editing

        function renderCheckboxes() {
            const container = document.getElementById('nodeCheckboxes');
            container.innerHTML = '';
            const nodes = getNodes();
            nodes.forEach(node => {
                const div = document.createElement('div');
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = node.name;
                cb.id = 'cb_' + node.name.replace(/\s/g,'_');
                const lbl = document.createElement('label');
                lbl.htmlFor = cb.id;
                lbl.textContent = node.name + (node.primary ? ' (primary)' : '');
                div.appendChild(cb);
                div.appendChild(lbl);
                container.appendChild(div);
            });
        }

        function renderGroupTable() {
            const tbody = document.querySelector('#groupTable tbody');
            tbody.innerHTML = '';
            const groups = getGroups();
            groups.forEach(g => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${g.name}</td>
                    <td>${g.nodes.join(', ')}</td>
                    <td>
                        <span class="icon" title="Edit" onclick="editGroup('${g.name}')">Edit</span>
                        <span class="icon" title="Download CSV" onclick="downloadGroup('${g.name}')">Download</span>
                        <span class="icon" title="Delete" onclick="deleteGroup('${g.name}')">Delete</span>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        // ----- Create / Update Group -----
        document.getElementById('createGroup').addEventListener('click', () => {
            const name = document.getElementById('groupName').value.trim();
            if (!name) { alert('Group name required.'); return; }

            const checked = Array.from(document.querySelectorAll('#nodeCheckboxes input:checked'))
                                 .map(cb => cb.value);
            if (checked.length < 1) { alert('Select at least one node.'); return; }

            const groups = getGroups();
            const idx = groups.findIndex(g => g.name === name);

            const groupObj = {name, nodes: checked};

            if (editingGroup) {
                // ---- UPDATE ----
                if (idx > -1) groups[idx] = groupObj;
                else { alert('Group name changed – treating as new group.'); groups.push(groupObj); }
                editingGroup = null;
                document.getElementById('createGroup').textContent = 'Create Group';
            } else {
                // ---- CREATE ----
                if (idx > -1) { alert('Group already exists – use Edit.'); return; }
                groups.push(groupObj);
            }
            saveGroups(groups);
            renderGroupTable();
            clearGroupForm();
        });

        window.editGroup = function(name) {
            const groups = getGroups();
            const grp = groups.find(g => g.name === name);
            if (!grp) return;

            document.getElementById('groupName').value = grp.name;
            // uncheck all
            document.querySelectorAll('#nodeCheckboxes input').forEach(cb=>cb.checked=false);
            // check belonging nodes
            grp.nodes.forEach(n => {
                const cb = document.getElementById('cb_' + n.replace(/\s/g,'_'));
                if (cb) cb.checked = true;
            });

            editingGroup = name;
            document.getElementById('createGroup').textContent = 'Update Group';
        };

        // ----- Download CSV -----
        window.downloadGroup = function(name) {
            const nodes = getNodes();
            const groups = getGroups();
            const grp = groups.find(g => g.name === name);
            if (!grp) return;

            const primary = nodes.find(n => n.name === name);
            const members = nodes.filter(n => grp.nodes.includes(n.name));
            const all = primary ? [primary, ...members] : members;

            const headers = ['Location Name','Latitude','Longitude','Height','Notes'];
            const rows = all.map(n => [
                `"${n.name.replace(/"/g,'""')}"`,
                n.latitude,
                n.longitude,
                n.height ?? '',
                `"${(n.notes||'').replace(/"/g,'""')}"`
            ]);
            const csv = [headers, ...rows.map(r=>r.join(','))].join('\n');

            const blob = new Blob([csv], {type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `${name}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // ----- Delete Group -----
        window.deleteGroup = function(name) {
            if (!confirm(`Delete group "${name}"? This cannot be undone.`)) return;
            const groups = getGroups().filter(g => g.name !== name);
            saveGroups(groups);
            renderGroupTable();
        };

        function clearGroupForm() {
            document.getElementById('groupName').value = '';
            document.querySelectorAll('#nodeCheckboxes input').forEach(cb=>cb.checked=false);
            editingGroup = null;
            document.getElementById('createGroup').textContent = 'Create Group';
        }

        // ----- Clear All Data -----
        document.getElementById('clearAll').addEventListener('click', () => {
            const msg = `WARNING: This will erase ALL nodes and groups from your browser.\n` +
                        `Download any CSV you need first!\n\n` +
                        `Are you sure?`;
            if (confirm(msg)) {
                localStorage.removeItem('nodes');
                localStorage.removeItem('groups');
                renderCheckboxes();
                renderGroupTable();
                renderMap();
                clearNodeForm();
                clearGroupForm();
            }
        });

        // ---------- Init ----------
        renderCheckboxes();
        renderGroupTable();
        renderMap();
    </script>
</body>
</html>
