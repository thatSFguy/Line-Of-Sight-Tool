<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Node Manager</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg: #f9f9fb;
            --text: #333;
            --border: #ddd;
            --primary: #007bff;
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
            --dark-bg: #2c3e50;
            --dark-text: #ecf0f1;
        }

        [data-theme="dark"] {
            --bg: #2c3e50;
            --text: #ecf0f1;
            --border: #444;
            --primary: #3498db;
        }

        [data-theme="dark"] .notice {
            background: #d39e00;
            color: #fff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: var(--bg);
            color: var(--text);
            transition: background 0.3s, color 0.3s;
        }

        h1, h2 { color: var(--primary); margin-bottom: 10px; }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 15px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] table { background: #34495e; }

        th, td {
            border: 1px solid var(--border);
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
            font-weight: 600;
        }

        [data-theme="dark"] th { background-color: #3a546e; }

        tr:hover { background-color: #f5f5f5; }
        [data-theme="dark"] tr:hover { background-color: #3a546e; }

        .error { color: var(--danger); margin: 10px 0; font-weight: 500; }
        .success { color: var(--success); margin: 10px 0; }

        .form-group {
            margin: 12px 0;
            display: flex;
            align-items: center;
        }

        .form-group label {
            width: 110px;
            font-weight: 500;
        }

        .form-group input, .form-group textarea {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:invalid {
            border-color: var(--danger);
        }

        button {
            margin: 5px 5px 5px 0;
            padding: 8px 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: 0.2s;
        }

        button:hover { opacity: 0.9; transform: translateY(-1px); }

        #addNodeBtn { background: var(--primary); color: white; }
        #cancelBtn { background: #6c757d; color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: #212529; }

        .controls { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px; }
        .container { display: flex; flex-direction: row; gap: 20px; flex-wrap: wrap; }
        .form-container { flex: 0 0 300px; min-width: 280px; }
        .map-container { flex: 1; min-width: 300px; }

        #map { height: 400px; width: 100%; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }

        .map-instructions {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            font-style: italic;
        }

        .trash-btn, .edit-btn, .download-btn, .delete-group-btn {
            cursor: pointer;
            font-size: 18px;
            margin: 0 6px;
            transition: 0.2s;
        }

        .trash-btn { color: var(--danger); }
        .edit-btn { color: var(--primary); }
        .download-btn { color: var(--success); }
        .delete-group-btn { color: var(--danger); }

        .search-container {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #searchInput {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        .table-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .leaflet-popup-content {
            font-size: 14px;
        }

        .theme-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notice {
            background: var(--warning);
            color: #212529;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <button class="theme-toggle" onclick="toggleTheme()"></button>

    <h1>
    Node Manager 
    <small style="font-size: 0.55em; color: #666;">
        <a href="index.html" style="color: inherit; text-decoration: underline;">Line of Sight Tool</a>
    </small>
    </h Subtitle1>

    <div class="notice">Note: Your nodes and groups are stored in your browser's localStorage. Please download the CSV before clearing your cache or switching browsers to avoid data loss.</div>

    <div class="container">
        <div class="form-container">
            <div class="form-group">
                <label>Location Name:</label>
                <input type="text" id="name" placeholder="e.g., Site A" required>
            </div>
            <div class="form-group">
                <label>Latitude:</label>
                <input type="number" step="any" id="latitude" placeholder="e.g., 39.9612" required>
            </div>
            <div class="form-group">
                <label>Longitude:</label>
                <input type="number" step="any" id="longitude" placeholder="e.g., -82.9988" required>
            </div>
            <div class="form-group">
                <label>Height (m):</label>
                <input type="number" step="any" id="height" placeholder="e.g., 10">
            </div>
            <div class="form-group">
                <label>Notes:</label>
                <textarea id="notes" placeholder="Optional notes..." rows="2"></textarea>
            </div>

            <div id="form-buttons">
                <button id="addNodeBtn" onclick="addNode()">Add Node</button>
                <button id="cancelBtn" style="display: none;" onclick="cancelEdit()">Cancel</button>
            </div>

            <div class="controls">
                <button onclick="triggerCSVUpload()">Upload CSV</button>
                <button onclick="downloadCSV()">Download CSV</button>
                <button onclick="createGroup()" class="btn-success">Create Group</button>
                <button onclick="fitMapToNodes()" class="btn-warning">Fit Map</button>
            </div>

            <div id="error" class="error"></div>
            <div id="success" class="success"></div>
        </div>

        <div class="map-container">
            <div class="map-instructions">Click map to set Lat/Lng ‚Ä¢ Click markers to edit</div>
            <div id="map"></div>
        </div>
    </div>

    <h2>Nodes</h2>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search nodes..." onkeyup="filterTable()">
        <div class="table-actions">
            <button onclick="selectAllIncluded(true)">Select All</button>
            <button onclick="selectAllIncluded(false)">Clear All</button>
        </div>
    </div>

    <table id="nodeTable">
        <thead>
            <tr>
                <th>Include</th>
                <th>Primary</th>
                <th>Location Name</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>Height (m)</th>
                <th>Notes</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="nodeTableBody"></tbody>
    </table>

    <h2>Groups</h2>
    <table id="groupTable">
        <thead>
            <tr>
                <th>Group Name</th>
                <th>Included Nodes</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="groupTableBody"></tbody>
    </table>

    <script>
        // === Theme Toggle ===
        const themeButton = document.querySelector('.theme-toggle');
        function toggleTheme() {
            const current = document.body.getAttribute('data-theme') || 'light';
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeButton.innerHTML = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Load theme
        let savedTheme = localStorage.getItem('theme');
        if (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            savedTheme = 'dark';
        }
        if (savedTheme) {
            document.body.setAttribute('data-theme', savedTheme);
        }
        themeButton.innerHTML = (document.body.getAttribute('data-theme') || 'light') === 'dark' ? '‚òÄÔ∏è' : 'üåô';

        // === Data ===
        const initialNodes = [
            { name: 'Site A', latitude: 39.9612, longitude: -82.9988, height: 10, notes: 'blah', included: false, primary: false },
            { name: 'Site B', latitude: 45.4215, longitude: -75.6972, height: 15, notes: 'bleh', included: false, primary: false },
            { name: 'Site C', latitude: 19.4326, longitude: -99.1332, height: 12, notes: 'nothing', included: false, primary: false }
        ];

        let nodes = JSON.parse(localStorage.getItem('nodes')) || initialNodes;
        let groups = JSON.parse(localStorage.getItem('groups')) || [];
        let editIndex = null;
        let map, markers = L.featureGroup();

        // === Map Setup ===
        map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Geolocation
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                map.setView([pos.coords.latitude, pos.coords.longitude], 10);
            }, () => fitMapToNodes());
        } else {
            fitMapToNodes();
        }

        // Click to set lat/lng
        map.on('click', e => {
            document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
            document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
        });

        // === Render Functions ===
        function renderNodeTable(filter = '') {
            const tbody = document.getElementById('nodeTableBody');
            tbody.innerHTML = '';
            const filtered = nodes.filter(n => 
                n.name.toLowerCase().includes(filter) ||
                n.notes.toLowerCase().includes(filter) ||
                n.latitude.toString().includes(filter) ||
                n.longitude.toString().includes(filter)
            );

            filtered.forEach((node, idx) => {
                const realIdx = nodes.indexOf(node);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" ${node.included ? 'checked' : ''} onchange="updateIncluded(${realIdx}, this.checked)"></td>
                    <td><input type="radio" name="primary" ${node.primary ? 'checked' : ''} onchange="setPrimary(${realIdx})"></td>
                    <td>${escapeHtml(node.name)}</td>
                    <td>${node.latitude.toFixed(6)}</td>
                    <td>${node.longitude.toFixed(6)}</td>
                    <td>${node.height || ''}</td>
                    <td>${escapeHtml(node.notes || '')}</td>
                    <td>
                        <span class="edit-btn" onclick="editNode(${realIdx})">‚úèÔ∏è</span>
                        <span class="trash-btn" onclick="deleteNode(${realIdx})">üóëÔ∏è</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
            localStorage.setItem('nodes', JSON.stringify(nodes));
            updateMapMarkers();
        }

        function renderGroupTable() {
            const tbody = document.getElementById('groupTableBody');
            tbody.innerHTML = '';
            groups.forEach((group, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHtml(group.name)}</td>
                    <td>${group.nodes.map(escapeHtml).join(', ') || 'None'}</td>
                    <td>
                        <span class="download-btn" onclick="downloadGroupCSV(${index})">‚¨áÔ∏è</span>
                        <span class="delete-group-btn" onclick="deleteGroup(${index})">üóëÔ∏è</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
            localStorage.setItem('groups', JSON.stringify(groups));
        }

        // === Map Markers ===
        function updateMapMarkers() {
            markers.clearLayers();
            nodes.forEach((node, i) => {
                if (isNaN(node.latitude) || isNaN(node.longitude)) return;
                const marker = L.marker([node.latitude, node.longitude])
                    .addTo(markers)
                    .bindPopup(getPopupContent(node, i), { closeButton: false });

                marker.on('click', () => editNode(i));
            });
            map.addLayer(markers);
        }

        function getPopupContent(node, i) {
            return `
                <b>${escapeHtml(node.name)}</b><br>
                Lat: ${node.latitude.toFixed(6)}<br>
                Lng: ${node.longitude.toFixed(6)}<br>
                <button onclick="editNode(${i}); map.closePopup();" style="margin-top:5px; padding:3px 8px; font-size:12px;">
                    Edit Node
                </button>
            `;
        }

        function fitMapToNodes() {
            if (markers.getLayers().length > 0) {
                map.fitBounds(markers.getBounds().pad(0.1));
            }
        }

        // === Node CRUD ===
        function addNode() {
            clearMessages();
            const name = document.getElementById('name').value.trim();
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            const height = parseFloat(document.getElementById('height').value) || null;
            const notes = document.getElementById('notes').value.trim();

            if (!name || isNaN(lat) || isNaN(lng)) {
                showError('Name, Latitude, and Longitude are required.');
                return;
            }

            if (editIndex !== null) {
                const oldName = nodes[editIndex].name;
                nodes[editIndex] = { name, latitude: lat, longitude: lng, height, notes: notes || '', included: nodes[editIndex].included, primary: nodes[editIndex].primary };
                updateGroupsOnNameChange(oldName, name);
                editIndex = null;
                document.getElementById('addNodeBtn').textContent = 'Add Node';
                document.getElementById('cancelBtn').style.display = 'none';
                showSuccess('Node updated!');
            } else {
                nodes.push({ name, latitude: lat, longitude: lng, height, notes: notes || '', included: false, primary: false });
                showSuccess('Node added!');
            }

            clearForm();
            renderNodeTable();
            renderGroupTable();
        }

        function editNode(index) {
            const node = nodes[index];
            document.getElementById('name').value = node.name;
            document.getElementById('latitude').value = node.latitude;
            document.getElementById('longitude').value = node.longitude;
            document.getElementById('height').value = node.height || '';
            document.getElementById('notes').value = node.notes || '';
            document.getElementById('addNodeBtn').textContent = 'Save';
            document.getElementById('cancelBtn').style.display = 'inline';
            editIndex = index;
            clearMessages();
        }

        function cancelEdit() {
            clearForm();
            document.getElementById('addNodeBtn').textContent = 'Add Node';
            document.getElementById('cancelBtn').style.display = 'none';
            editIndex = null;
            clearMessages();
        }

        function deleteNode(index) {
            if (nodes[index].primary) {
                showError('Cannot delete the primary node.');
                return;
            }
            if (confirm(`Delete "${nodes[index].name}"?`)) {
                const name = nodes[index].name;
                nodes.splice(index, 1);
                groups = groups.filter(g => g.name !== name);
                groups.forEach(g => g.nodes = g.nodes.filter(n => n !== name));
                renderNodeTable();
                renderGroupTable();
                showSuccess('Node deleted.');
            }
        }

        function updateIncluded(index, checked) {
            nodes[index].included = checked;
            if (nodes[index].primary) nodes[index].included = true;
            renderNodeTable();
        }

        function setPrimary(index) {
            nodes.forEach((n, i) => {
                n.primary = i === index;
                if (i === index) n.included = true;
            });
            renderNodeTable();
        }

        // === Groups ===
        function createGroup() {
            clearMessages();

            const primary = nodes.find(n => n.primary);
            const included = nodes.filter(n => n.included && !n.primary);

            if (!primary) {
                showError('Select a Primary node.');
                return;
            }
            if (included.length === 0) {
                showError('Select at least one Included node.');
                return;
            }

            const existingIdx = groups.findIndex(g => g.name === primary.name);

            if (existingIdx !== -1) {
                if (!confirm(`Group "${primary.name}" already exists.\n\nOverwrite it?`)) {
                    return;
                }
                groups[existingIdx] = {
                    name: primary.name,
                    nodes: included.map(n => n.name)
                };
                showSuccess(`Group "${primary.name}" overwritten!`);
            } else {
                groups.push({
                    name: primary.name,
                    nodes: included.map(n => n.name)
                });
                showSuccess(`Group "${primary.name}" created!`);
            }

            renderGroupTable();
        }

        function deleteGroup(index) {
            if (confirm(`Delete group "${groups[index].name}"?`)) {
                groups.splice(index, 1);
                renderGroupTable();
                showSuccess('Group deleted.');
            }
        }

        function updateGroupsOnNameChange(oldName, newName) {
            groups.forEach(g => {
                if (g.name === oldName) g.name = newName;
                g.nodes = g.nodes.map(n => n === oldName ? newName : n);
            });
            renderGroupTable();
        }

        // === CSV ===
        function downloadCSV() {
            const headers = ['Location Name', 'Latitude', 'Longitude', 'Height', 'Notes'];
            const rows = nodes.map(n => [
                `"${n.name.replace(/"/g, '""')}"`,
                n.latitude,
                n.longitude,
                n.height || '',
                `"${(n.notes || '').replace(/"/g, '""')}"`
            ].join(','));
            downloadFile([headers.join(','), ...rows].join('\n'), 'nodes.csv');
        }

        function downloadGroupCSV(index) {
            const group = groups[index];
            const primaryNode = nodes.find(n => n.name === group.name);
            const includedNodes = nodes.filter(n => group.nodes.includes(n.name));
            const groupNodes = primaryNode ? [primaryNode, ...includedNodes] : includedNodes;
            const headers = ['Location Name', 'Latitude', 'Longitude', 'Height', 'Notes'];
            const rows = groupNodes.map(n => [
                `"${n.name.replace(/"/g, '""')}"`, n.latitude, n.longitude, n.height || '', `"${(n.notes || '').replace(/"/g, '""')}"`
            ].join(','));
            downloadFile([headers.join(','), ...rows].join('\n'), `${group.name}.csv`);
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; a.click();
            URL.revokeObjectURL(url);
        }

        function triggerCSVUpload() {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.csv';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) uploadCSV(file);
            };
            input.click();
        }

        function uploadCSV(file) {
            const reader = new FileReader();
            reader.onload = e => {
                const lines = e.target.result.split('\n').map(l => l.trim());
                if (lines.length < 1) return showError('CSV is empty.');

                const headers = parseCSVLine(lines[0]);
                const expected = ['Location Name', 'Latitude', 'Longitude', 'Height', 'Notes'];
                if (!headers.slice(0, 3).every((h, i) => h === expected[i])) {
                    return showError('Invalid headers. Expected: Location Name, Latitude, Longitude...');
                }

                const newNodes = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length < 3 || !values[0] || isNaN(values[1]) || isNaN(values[2])) continue;
                    const height = values[3] && !isNaN(values[3]) ? parseFloat(values[3]) : null;
                    newNodes.push({
                        name: values[0], latitude: parseFloat(values[1]), longitude: parseFloat(values[2]),
                        height, notes: values[4] || '', included: false, primary: false
                    });
                }

                if (newNodes.length === 0) return showError('No valid rows found.');

                const replace = confirm('Replace existing nodes? (Cancel = Append)');
                nodes = replace ? newNodes : [...nodes, ...newNodes];
                if (replace) groups = [];
                renderNodeTable(); renderGroupTable();
                showSuccess(`${newNodes.length} nodes ${replace ? 'replaced' : 'appended'}.`);
            };
            reader.readAsText(file);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result.map(v => v.replace(/^"|"$/g, '').replace(/""/g, '"'));
        }

        // === Utilities ===
        function clearForm() {
            ['name', 'latitude', 'longitude', 'height', 'notes'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        function clearMessages() {
            document.getElementById('error').textContent = '';
            document.getElementById('success').textContent = '';
        }

        function showError(msg) {
            document.getElementById('error').textContent = msg;
            document.getElementById('success').textContent = '';
        }

        function showSuccess(msg) {
            document.getElementById('success').textContent = msg;
            document.getElementById('error').textContent = '';
            setTimeout(clearMessages, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function filterTable() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            renderNodeTable(term);
        }

        function selectAllIncluded(checked) {
            nodes.forEach(n => { if (!n.primary) n.included = checked; });
            renderNodeTable();
        }

        // Enter key to submit
        document.addEventListener('keydown', e => {
            if (e.key === 'Enter' && e.target.tagName === 'INPUT' && !['TEXTAREA'].includes(e.target.tagName)) {
                addNode();
            }
        });

        // Initial render
        renderNodeTable();
        renderGroupTable();
        updateMapMarkers();
    </script>
</body>
</html>
